name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            EVENT TYPE: ${{ github.event.action }}
            BEFORE SHA: ${{ github.event.before }}
            CURRENT SHA: ${{ github.event.pull_request.head.sha }}

            Review this pull request. The PR DESCRIPTION is the SINGLE SOURCE OF TRUTH.
            Your approach depends on the EVENT TYPE: "${{ github.event.action }}"

            IMPORTANT: PRESERVE the original PR description written by the author.
            APPEND your review under a "## ü§ñ Claude Code Review" heading.

            ========================================
            ## EVENT TYPE: "opened" (New PR)
            ========================================

            ### Step 1: Gather Information
            1. Get the ORIGINAL PR description first:
               `gh pr view ${{ github.event.pull_request.number }} --json body -q .body`
               Store this ‚Äî you MUST preserve it.
            2. Run `gh pr diff ${{ github.event.pull_request.number }}` to see all changes
            3. Read the repository's CLAUDE.md for style and conventions guidance
            4. Analyze for: code quality, bugs, performance, security, test coverage

            ### Step 2: Update PR Description
            Use `gh pr edit ${{ github.event.pull_request.number }} --body "$(cat <<'EOF'
            ...content...
            EOF
            )"` with this EXACT structure:

            ```
            [ORIGINAL PR DESCRIPTION ‚Äî preserve exactly as written by author]

            ---

            ## ü§ñ Claude Code Review

            ### Summary
            [1-2 sentence description of what this PR accomplishes]

            ### Key Changes
            - [Major change 1]
            - [Major change 2]
            - [Major change 3]

            ### Issues Found
            | # | Topic | Issue | File | Status |
            |---|-------|-------|------|--------|
            | 1 | üîí Security | [Brief description] | `path/file.ts:42` | ‚è≥ Open |
            | 2 | üêõ Logic | [Brief description] | `path/file.ts:67` | ‚è≥ Open |
            | 3 | ‚ö° Perf | [Brief description] | `path/file.ts:89` | ‚è≥ Open |

            (If NO issues found, display: "**Issues Found:** None ‚úÖ")

            ### Confidence Score: X/5
            [1-2 sentence justification based on open issues]

            ### Important Files Changed
            | File | Changes |
            |------|---------|
            | `path/to/file.ts` | Brief description |

            <details>
            <summary>üìã Fix Prompts (for AI-assisted fixes)</summary>

            #### Issue #1 ‚Äî üîí Security: [Title]
            ```
            File: path/file.ts:42
            Problem: [Detailed explanation of the issue]
            Impact: [Why this matters]
            Suggested fix: [Concrete suggestion]
            ```

            #### Issue #2 ‚Äî üêõ Logic: [Title]
            ```
            File: path/file.ts:67
            Problem: [Detailed explanation]
            Impact: [Why this matters]
            Suggested fix: [Concrete suggestion]
            ```

            (Repeat for each issue. If no issues, omit this entire section.)

            </details>

            ---
            *ü§ñ Last reviewed: `SHORT_SHA` at TIMESTAMP*
            ```

            ### Step 3: Create Inline Comments (for each issue)
            For EACH issue in the table, create an inline comment on the specific file/line using:
            `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments -f body="..." -f commit_id="FULL_SHA" -f path="file/path.ts" -f line=LINE_NUMBER`

            Inline comment format:
            ```
            **Issue #[N] ‚Äî [TOPIC_EMOJI] [Topic]: [Title]**

            [Brief explanation of the problem]

            üìã See **Fix Prompts** section in PR description for detailed fix guidance.
            ```

            ========================================
            ## EVENT TYPE: "synchronize" (New Commits)
            ========================================

            ### Step 1: Gather Information
            1. Get current PR description:
               `gh pr view ${{ github.event.pull_request.number }} --json body -q .body`
            2. Get ONLY the new changes since last review:
               `gh api repos/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.pull_request.head.sha }} --jq '.files[] | "File: \(.filename)\n\(.patch // \"binary\")\n---"'`
            3. Review ONLY these new commits ‚Äî do NOT re-review previously reviewed code
            4. Check if any open issues (‚è≥) in the Issues Found table are now fixed

            ### Step 2: Update PR Description ‚Äî MINIMAL CHANGES ONLY
            The PR description has TWO parts separated by `## ü§ñ Claude Code Review`:
            1. **ORIGINAL DESCRIPTION** (above the heading) ‚Äî NEVER modify this
            2. **CLAUDE CODE REVIEW** (below the heading) ‚Äî only update specific sections

            Within the Claude Code Review section, update ONLY:

            **A. Issues Found table:**
            - Fixed issues: Change `‚è≥ Open` ‚Üí `‚úÖ Fixed (\`SHORT_SHA\`)`
            - New issues in new commits: Add new rows with next number, `‚è≥ Open`
            - NEVER remove rows, NEVER renumber existing issues

            **B. Fix Prompts section:**
            - For fixed issues: Keep the prompt but add "‚úÖ RESOLVED in \`SHORT_SHA\`" at the top
            - For new issues: Add new prompt entries matching the new table rows

            **C. Confidence Score:**
            - Update score and justification based on current open issue count

            **D. Review History (add after Important Files Changed, before Fix Prompts):**
            ```
            ### Review History
            - `SHORT_SHA`: [What changed ‚Äî e.g., "Fixed #1, #3; Added new endpoint"]
            ```
            If Review History exists, append new entry. If not, create it.

            **E. Last reviewed timestamp:**
            - Update SHA and timestamp

            **DO NOT MODIFY:** Original description, Summary, Key Changes, Important Files Changed

            ### Step 3: Inline Comments for NEW Issues Only
            Create inline comments ONLY for newly discovered issues (not for status updates on existing issues).

            ========================================
            ## Topic Categories
            ========================================
            | Emoji | Topic | Use for |
            |-------|-------|---------|
            | üîí | Security | Vulnerabilities, secrets, auth, injection |
            | üêõ | Logic | Bugs, race conditions, incorrect behavior |
            | ‚ö° | Perf | N+1 queries, memory leaks, slow operations |
            | üßπ | Quality | Missing error handling, unclear code |
            | üß™ | Testing | Missing tests, uncovered edge cases |
            | üìù | Types | Type errors, missing types, any abuse |

            ========================================
            ## Scoring Guidelines
            ========================================
            - **5/5**: No open issues, ready to merge
            - **4/5**: Minor open issues (Quality/Types), safe to merge
            - **3/5**: Some concerns that should be addressed (Perf/Testing)
            - **2/5**: Significant issues requiring changes (Logic bugs)
            - **1/5**: Critical problems, do not merge (Security)

            ========================================
            ## Review Guidelines
            ========================================
            - Be concise but thorough
            - Always include file path AND line number
            - Focus on substantive issues, not style nitpicks
            - For synchronize: ONLY flag NEW issues in new commits
            - Be constructive and actionable

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh pr edit:*),Bash(gh api:*)"'
